#include <stdio.h>
#include <time.h>
#include "structs.h"
#include "io.h"
#include "fir_alt.h"
#include "demodulator.h"
#include "resample.h"
#include "get_lr.h"

#define SIZE_FIR 257
#define SIZE_RES 5
#define SIZE_DEC 5
#define SIZE_READ 1875
#define SIZE_WRITE 9

void delay(unsigned int mseconds)
{
    clock_t goal = mseconds + clock();
    while (goal > clock());
}

int main(int argc, char *argv[]) {
	/****************************************************************************
	 * START OF DECLARATIONS
	 *****************************************************************************/
	printf("START\n");

	/* FILE PATHS */
	printf("Reading arguments...\n");
	char *p_FILE_IN = argv[1];
	char *p_FILE_LEFT = argv[2];
	char *p_FILE_RIGHT = argv[3];
	printf("Arguments read!\n");
	
	/* FIR FILTER */
	static const float H_SUM[SIZE_FIR] =  {
  0.0001563822443,-0.0001705772011,-0.000485371449,-0.0006499545416,-0.0005679610767,
  -0.0002336893376,0.0002510985942, 0.000704717706,0.0009317818331, 0.000804733776,
  0.0003275190829,-0.0003483576293,-0.0009684182587,-0.001269058324,-0.001086840173,
  -0.0004388338421,0.0004632581549, 0.001278680633, 0.001664309297, 0.001416153507,
  0.0005682821502,-0.000596379803,-0.001636836561, -0.00211894582, -0.00179362006,
  -0.0007161491667,0.0007479297929, 0.002043220447, 0.002633118303, 0.002219145186,
  0.0008823148091,-0.0009177026805,-0.002497067908,-0.003205598798,-0.002691503614,
   -0.00106622139,  0.00110505044, 0.002996443538,  0.00383369741, 0.003208277281,
   0.001266852487,-0.001308863284,-0.003538197139,-0.004513217602,-0.003765825648,
  -0.001482724096, 0.001527564018, 0.004117956385, 0.005238455255, 0.004359292798,
   0.001711889869, -0.00175911549,-0.004730152432,-0.006002238486,-0.004982647952,
  -0.001951959566, 0.002001042245, 0.005368085112, 0.006796021014, 0.005628764629,
   0.002200132469,-0.002250466729,-0.006024024449,-0.007610010915,-0.006289536599,
  -0.002453243826, 0.002504157834, 0.006689345464, 0.008433349431, 0.006956025492,
   0.002707823645,-0.002758593298,-0.007354694419,-0.009254323319,-0.007618641015,
  -0.002960168524, 0.003010031534, 0.008010188118,  0.01006061677,  0.00826734677,
   0.003206420457,-0.003254594514,-0.008645628579, -0.01083958149,  -0.0088918861,
  -0.003442655783, 0.003488356248, 0.009250741452,  0.01157853287, 0.009482019581,
   0.003664976219,-0.003707434982,-0.009815418161, -0.01226505544, -0.01002777554,
  -0.003869605018, 0.003908089362,  0.01032996457,  0.01288730558,  0.01051969547,
    0.00405297894,-0.004086810164, -0.01078534499, -0.01343431138, -0.01094907057,
   -0.00421184022, 0.004240410402,  0.01117341034,  0.01389625203,  0.01130816806,
   0.004343318287,-0.004366107285, -0.01148711238,  -0.0142647149, -0.01159043144,
  -0.004445007537, 0.004461595323,  0.01172068156,  0.01453291066,   0.0117906509,
   0.004515027162,-0.004525105469, -0.01186978724, -0.01469585858, -0.01190510206,
  -0.004552073777, 0.004555454012,  0.01193164662,  0.01475051604,  0.01193164662,
   0.004555454012,-0.004552073777, -0.01190510206, -0.01469585858, -0.01186978724,
  -0.004525105469, 0.004515027162,   0.0117906509,  0.01453291066,  0.01172068156,
   0.004461595323,-0.004445007537, -0.01159043144,  -0.0142647149, -0.01148711238,
  -0.004366107285, 0.004343318287,  0.01130816806,  0.01389625203,  0.01117341034,
   0.004240410402, -0.00421184022, -0.01094907057, -0.01343431138, -0.01078534499,
  -0.004086810164,  0.00405297894,  0.01051969547,  0.01288730558,  0.01032996457,
   0.003908089362,-0.003869605018, -0.01002777554, -0.01226505544,-0.009815418161,
  -0.003707434982, 0.003664976219, 0.009482019581,  0.01157853287, 0.009250741452,
   0.003488356248,-0.003442655783,  -0.0088918861, -0.01083958149,-0.008645628579,
  -0.003254594514, 0.003206420457,  0.00826734677,  0.01006061677, 0.008010188118,
   0.003010031534,-0.002960168524,-0.007618641015,-0.009254323319,-0.007354694419,
  -0.002758593298, 0.002707823645, 0.006956025492, 0.008433349431, 0.006689345464,
   0.002504157834,-0.002453243826,-0.006289536599,-0.007610010915,-0.006024024449,
  -0.002250466729, 0.002200132469, 0.005628764629, 0.006796021014, 0.005368085112,
   0.002001042245,-0.001951959566,-0.004982647952,-0.006002238486,-0.004730152432,
   -0.00175911549, 0.001711889869, 0.004359292798, 0.005238455255, 0.004117956385,
   0.001527564018,-0.001482724096,-0.003765825648,-0.004513217602,-0.003538197139,
  -0.001308863284, 0.001266852487, 0.003208277281,  0.00383369741, 0.002996443538,
    0.00110505044, -0.00106622139,-0.002691503614,-0.003205598798,-0.002497067908,
  -0.0009177026805,0.0008823148091, 0.002219145186, 0.002633118303, 0.002043220447,
  0.0007479297929,-0.0007161491667, -0.00179362006, -0.00211894582,-0.001636836561,
  -0.000596379803,0.0005682821502, 0.001416153507, 0.001664309297, 0.001278680633,
  0.0004632581549,-0.0004388338421,-0.001086840173,-0.001269058324,-0.0009684182587,
  -0.0003483576293,0.0003275190829, 0.000804733776,0.0009317818331, 0.000704717706,
  0.0002510985942,-0.0002336893376,-0.0005679610767,-0.0006499545416,-0.000485371449,
  -0.0001705772011,0.0001563822443};
	// Sum filter coefficients
	static const float H_DIFF[SIZE_FIR] = {
  -0.0004703743325,-0.0002808999852,7.516969345e-05,0.0004594390921,0.0006962781772,
  0.0006507130456,0.0002990313224,-0.0002429449523,-0.0007535843179,-0.0009938942967,
  -0.0008163836901,-0.0002458355448,0.0005095066153, 0.001130374731,  0.00131918746,
  0.0009388236795,9.410110943e-05,-0.0008881067042,-0.001582341967,-0.001646445016,
  -0.0009850675706,0.0001815634896, 0.001384557458, 0.002092183335,  0.00194217742,
  0.0009200964123,-0.0006017229171,-0.001994939987,-0.002632269403,-0.002166707767,
  -0.0007098381175, 0.001179049024, 0.002703888575, 0.003165111877, 0.002276672982,
  0.0003246033448,-0.001915508765,-0.003483718028,-0.003644887591,-0.002228306606,
  0.0002573343518, 0.002800130052, 0.004294601269, 0.004020010121, 0.001981285634,
  -0.001046356629,-0.003807651112,-0.005085922312,-0.004236632958,-0.001502826111,
   0.002038676059, 0.004898295272, 0.005798816215,  0.00424285559,0.0007716649561,
  -0.003214412136, -0.00601883512,-0.006369799841,-0.003993313294, 0.000218471032,
   0.004536854569, 0.007104982156, 0.006735264324, 0.003453759011,-0.001456287922,
  -0.005953109823,-0.008085027337,-0.006836499088,-0.002605208196, 0.002911570482,
   0.007396208588, 0.008884511888, 0.006624846254, 0.001447228482,-0.004535288084,
  -0.008788618259,-0.009431604296,-0.006066520233,-4.079661068e-17, 0.006261279806,
    0.01004696731, 0.009662757628, 0.005146642216,-0.001695137471,-0.008009493351,
    -0.0110876495,-0.009528172202,-0.003872065572, 0.003576810006, 0.009690606967,
    0.01183289383, 0.008996565826, 0.002272675512,-0.005566423293, -0.01121172681,
   -0.01221678779,-0.008058802225,-0.0004009401891, 0.007572526112,  0.01248272974,
    0.01219075266, 0.006730001885,-0.001670331229,-0.009496429935, -0.01342274901,
   -0.01172795985,-0.005049870815, 0.003851930611,  0.01123868022,   0.0139662642,
    0.01082628313, 0.003081156639,-0.006043627858,   -0.012705856, -0.01406826172,
  -0.009509472176,-0.0009062788449, 0.008140590973,  0.01381716412,   0.0137080187,
   0.007826406509,-0.001377635403, -0.01004034374, -0.01451024879, -0.01289114729,
  -0.005848428234, 0.003664944554,  0.01164970733,  0.01474576071,  0.01164970733,
   0.003664944554,-0.005848428234, -0.01289114729, -0.01451024879, -0.01004034374,
  -0.001377635403, 0.007826406509,   0.0137080187,  0.01381716412, 0.008140590973,
  -0.0009062788449,-0.009509472176, -0.01406826172,   -0.012705856,-0.006043627858,
   0.003081156639,  0.01082628313,   0.0139662642,  0.01123868022, 0.003851930611,
  -0.005049870815, -0.01172795985, -0.01342274901,-0.009496429935,-0.001670331229,
   0.006730001885,  0.01219075266,  0.01248272974, 0.007572526112,-0.0004009401891,
  -0.008058802225, -0.01221678779, -0.01121172681,-0.005566423293, 0.002272675512,
   0.008996565826,  0.01183289383, 0.009690606967, 0.003576810006,-0.003872065572,
  -0.009528172202,  -0.0110876495,-0.008009493351,-0.001695137471, 0.005146642216,
   0.009662757628,  0.01004696731, 0.006261279806,-4.079661068e-17,-0.006066520233,
  -0.009431604296,-0.008788618259,-0.004535288084, 0.001447228482, 0.006624846254,
   0.008884511888, 0.007396208588, 0.002911570482,-0.002605208196,-0.006836499088,
  -0.008085027337,-0.005953109823,-0.001456287922, 0.003453759011, 0.006735264324,
   0.007104982156, 0.004536854569, 0.000218471032,-0.003993313294,-0.006369799841,
   -0.00601883512,-0.003214412136,0.0007716649561,  0.00424285559, 0.005798816215,
   0.004898295272, 0.002038676059,-0.001502826111,-0.004236632958,-0.005085922312,
  -0.003807651112,-0.001046356629, 0.001981285634, 0.004020010121, 0.004294601269,
   0.002800130052,0.0002573343518,-0.002228306606,-0.003644887591,-0.003483718028,
  -0.001915508765,0.0003246033448, 0.002276672982, 0.003165111877, 0.002703888575,
   0.001179049024,-0.0007098381175,-0.002166707767,-0.002632269403,-0.001994939987,
  -0.0006017229171,0.0009200964123,  0.00194217742, 0.002092183335, 0.001384557458,
  0.0001815634896,-0.0009850675706,-0.001646445016,-0.001582341967,-0.0008881067042,
  9.410110943e-05,0.0009388236795,  0.00131918746, 0.001130374731,0.0005095066153,
  -0.0002458355448,-0.0008163836901,-0.0009938942967,-0.0007535843179,-0.0002429449523,
  0.0002990313224,0.0006507130456,0.0006962781772,0.0004594390921,7.516969345e-05,
  -0.0002808999852,-0.0004703743325
};
	// Diff filter coefficients
	struct Buffer buff_fir_sum = {.SIZE=SIZE_FIR, .values={0}, .offset=0, .wait=0};
	struct Buffer buff_fir_diff = {.SIZE=SIZE_FIR, .values={0}, .offset=0, .wait=0};
	
	/* DEMODULATION */
	static const float SUM_OSC[5] = {1.000000,0.809017,0.309017,-0.309017,-0.809017};
	static const float DIFF_OSC[100] = {1.000000,0.790155,0.248690,-0.397148,-0.876307,-0.987688,-0.684547,-0.094108,0.535827,0.940881,0.951057,0.562083,
					    -0.062791,-0.661312,-0.982287,-0.891007,-0.425779,0.218143,0.770513,0.999507,0.809017,0.278991,-0.368125,-0.860742,
			 	 	    -0.992115,-0.707107,-0.125333,0.509041,0.929776,0.960294,0.587785,-0.031411,-0.637424,-0.975917,-0.904827,-0.453990,
			 		    0.187381,0.750111,0.998027,0.827081,0.309017,-0.338738,-0.844328,-0.995562,-0.728969,-0.156434,0.481754,0.917755,
			 		    0.968583,0.612907,0.000000,-0.612907,-0.968583,-0.917755,-0.481754,0.156434,0.728969,0.995562,0.844328,0.338738,
			 		    -0.309017,-0.827081,-0.998027,-0.750111,-0.187381,0.453990,0.904827,0.975917,0.637424,0.031411,-0.587785,-0.960294,
			 		    -0.929776,-0.509041,0.125333,0.707107,0.992115,0.860742,0.368125,-0.278991,-0.809017,-0.999507,-0.770513,-0.218143,
			 		    0.425779,0.891007,0.982287,0.661312,0.062791,-0.562083,-0.951057,-0.940881,-0.535827,0.094108,0.684547,0.987688,
			 		    0.876307,0.397148,-0.248690,-0.790155};
	struct Demod sum_osc = {.SIZE=5, .p_OSC=SUM_OSC, .index=0, .inverse=0};
	struct Demod diff_osc = {.SIZE=100, .p_OSC=DIFF_OSC, .index=0, .inverse=0};	

	/* RESAMPLE */
	static const float H0[SIZE_RES] = {0};
	static const float H1[SIZE_RES] = {0};
	static const float H2[SIZE_RES] = {0};
	struct Filter filter = {
		.SIZE = SIZE_RES,
		.p_H = {H0,H1,H2},
		.curr_res_filter = 0,
		.curr_dec_filter = 0
	};
	struct Buffer buff_res = {.SIZE=SIZE_RES, .values={0}, .offset=0, .wait=1}; // Resample buffer
	struct Buffer buff_dec = {.SIZE=SIZE_DEC, .values={0}, .offset=0, .wait=1}; // Decimation buffer

	/****************************************************************************
	* END OF DECLARATIONS
	*****************************************************************************/

	int exit = 0;
	int batch_size_res = 9; 
	int counter = 1;
	while (exit == 0) {
		// Read n=SIZE_READ samples from FILE_IN
		// Return a pointer to the first element in the batch and the batch size
		// printf("Reading inputs...\n");
		float batch[SIZE_READ] = {0};
		int batch_size;
		batch_size = read_batch(p_FILE_IN, SIZE_READ, batch, &exit);
		// printf("Inputs read\n");
		
		// Use FIR filter to split the batch into sum and diff
		// Return a pointer to the first element in the sum and diff array
		// printf("Starting FIR...\n");
		float sum[SIZE_READ] = {0};
		float diff[SIZE_READ] = {0};
		fir_alt(sum, batch_size, H_SUM, &buff_fir_sum);
		fir_alt(diff, batch_size, H_DIFF, &buff_fir_diff);
		// printf("Inputs filtered!\n");
		
		// Demodulate sum and diff
		// printf("Entering demodulator...\n");
		demod(sum, batch_size, &sum_osc);
		demod(diff, batch_size, &diff_osc);
		// printf("Demodulation complete!\n");
		
		// Resample sum and diff
		// printf("Starting resample...\n");
		float sum_res[SIZE_READ] = {0};
		float diff_res[SIZE_READ] = {0};
		batch_size_res = resample(sum, batch_size, sum_res, &filter, &buff_res, &buff_dec);
		batch_size_res = resample(diff, batch_size, diff_res, &filter, &buff_res, &buff_dec);
		printf("Resampling complete!\n");

		// Get left and right signals from sum and diff
		// printf("Getting left and right signals...\n");
		float left[SIZE_WRITE] = {0};
		float right[SIZE_WRITE];
		get_lr(sum_res, diff_res, left, right, batch_size_res);
		// printf("Left and right produced!\n");
		
		// Write left and right to file
		// printf("Writing to file...\n");
		write_batch(p_FILE_LEFT, batch_size_res, left);
		write_batch(p_FILE_RIGHT, batch_size_res, right);

		printf("Batch %d complete\n", counter);
	}
	printf("FIN.");
	return 0;
}
/*
// OLD

// Macros for program arguments
#define INPUT_FILE (argv[0])
#define OUT_LEFT_FILE (argv[1])
#define OUT_RIGHT_FILE (argv[2])


// Data for FDM demultiplexing using bandpass filters
static struct fir_buffer fdm_filter_buffer;
static float sum_fdm_filter_weights[FIR_FILTER_LEN] = {
    // Insert filter weights for the band pass FIR filter here
};
static float diff_fdm_filter_weights[FIR_FILTER_LEN] = {
    // Insert filter weights for the band pass FIR filter here
};

// Main entry point for program
void main(int argc, char *argv[]) {
    // Open input and output files
    FILE *input_fp = fopen(INPUT_FILE);
    FILE *out_left_fp = fopen(OUT_LEFT_FILE);
    FILE *out_right_fp = fopen(OUT_RIGHT_FILE);

    // Process the input file float by float.
    while (!feof(input_f)) {
        // Populate FDM FIR filter buffer from input file
        float *p_input = fir_buffer_next(&fdm_filter_buffer);
        fread((void *) p_input, sizeof(*p_input), input_fp)

        // Perform FDM de-multiplexing to obtain amplitude modulated signals for
        // each channel
        float sum_am;
        float diff_am;
        fir_filter(sum_fdm_filter_weights, &fdm_filter_buffer, &sum_am);
        fir_filter(diff_fdm_filter_weights, &fdm_filter_buffer, &diff_am);
    }
}*/
